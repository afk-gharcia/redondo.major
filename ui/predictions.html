<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Make your predictions for the CS2 Major Redondo.">
    <meta name="keywords" content="CS2, redondo, palpites, major, Counter-Strike">
    <title>Palpites</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/predictions.css">
    <link rel="stylesheet" href="css/components/stage.css">
    <link rel="stylesheet" href="css/components/game-row.css">
    <link rel="stylesheet" href="css/components/token-input.css">
    <link rel="stylesheet" href="css/components/nav.css">
</head>
<body>
    <div id="nav-placeholder"></div>
        <main>
                <div class="token-container">
                        <form id="token-form">
                            <div class="token-form-group">
                                <div class="token-input-group">
                                    <div id="error-msg" class="hidden"></div>
                                    <input type="text" class="token-input" id="token-input" placeholder="Digite seu token..." maxlength="5" required />
                                </div>
                                <button type="submit" class="btn-continuar">Continuar</button>
                            </div>
                        </form>
                </div>
            <div id="userId" class="hidden"></div>
        </main>
    <script type="module">
    import { loadNav } from './js/loadNav.js';
        loadNav('predictions');
    </script>
    <script type="module">
        import { showUserDisplayName } from './js/components/userDisplayName.js';
        import { loadMajorStages } from './js/predictions/loadMajorStages.js';
        import { API_BASE_URL } from './js/config.js';

        const form = document.getElementById('token-form');
        const tokenInput = document.getElementById('token-input');
        const errorMsg = document.getElementById('error-msg');
        const tokenContainer = document.querySelector('.token-container');
        const userIdDiv = document.getElementById('userId');

        const savedUserId = localStorage.getItem('userId');
        if (savedUserId) {
            tokenContainer.style.display = 'none';
            userIdDiv.style.display = 'block';
            loadMajorStages();
        }

        function shake(element) {
            element.classList.add('shake');
            setTimeout(() => {
                element.classList.remove('shake');
            }, 500);
        }

        function showError(msg) {
            errorMsg.textContent = msg;
            errorMsg.style.display = 'block';
            errorMsg.style.fontSize = '0.92em';
            errorMsg.style.fontWeight = 'bold';
            tokenInput.classList.add('error');
            shake(tokenInput);
            shake(errorMsg);
        }

        function hideError() {
            errorMsg.style.display = 'none';
            tokenInput.classList.remove('error');
        }

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            hideError();
            userIdDiv.style.display = 'none';
            const token = tokenInput.value.trim().toUpperCase();
            if (!token) return;
            try {
                // Endpoint Vercel para validação de token
                const res = await fetch(`${API_BASE_URL}/api/validateToken`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token })
                });
                const data = await res.json();
                if (data.valid) {
                    tokenContainer.style.display = 'none';
                    userIdDiv.style.display = 'block';
                    localStorage.setItem('userId', data.userId);
                    if (data.display_name) {
                        localStorage.setItem('display_name', data.display_name);
                    }
                    // Atualiza o menu superior para admin se necessário
                    import('./js/loadNav.js').then(mod => mod.loadNav('predictions'));
                    loadMajorStages();
                } else {
                    showError('Token inválido ..');
                }
            } catch (err) {
                showError('Erro de conexão com a API.');
            }
        });
    </script>
</body>
</html>
