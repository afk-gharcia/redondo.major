<!--
    Renders the predictions page for the Redondo CS2 Major.
    Author: afk-gharcia
    Provides interactive forms for users to submit game and classification predictions, with period-based logic and user authentication via token.
    For frontend use; fetches and renders all phase, game, and user prediction data dynamically.
-->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Faça seus palpites para o CS2 Major Redondo.">
    <meta name="keywords" content="CS2, redondo, palpites, major, Counter-Strike">
    <title>Palpites</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/predictions.css">
    <link rel="stylesheet" href="css/components/nav.css">
    <link rel="stylesheet" href="css/components/footBox.css">
</head>
<body>
    <div id="nav-placeholder"></div>
        <header id="player-tab" class="player-tab"></header>
    <div id="stage-tabs" class="stage-tabs"></div>
    <div id="stage-content-box"></div>
    <div id="foot-box" class="foot-box"></div>
    <main>
        <section class="token-container">
            <form id="token-form" autocomplete="off">
                <div class="token-form-group">
                    <div class="token-input-group">
                        <div id="error-msg" class="hidden"></div>
                        <label for="token-input" class="sr-only">Token</label>
                        <input type="text" class="token-input" id="token-input" placeholder="Digite seu token..." maxlength="5" required aria-label="Token" />
                    </div>
                    <button type="submit" class="btn-continuar">Continuar</button>
                </div>
            </form>
        </section>
        <div id="userId" class="hidden"></div>
    </main>
    <script type="module">
    function handleEditPlayerTab() {
        const playerId = localStorage.getItem('userId');
        const currentName = localStorage.getItem('display_name') || '';
        showPlayerEditPopup({
            currentName,
            playerId,
            onSuccess: (newName) => {
                localStorage.setItem('display_name', newName);
                showPlayerTab(newName, { onEdit: handleEditPlayerTab });
            }
        });
    }

    import { loadNav } from './js/components/nav.js';
    import { API_BASE_URL } from './js/config.js';
    import { showPlayerEditPopup } from './js/components/playerEditPopup.js';
    import { loadPredictions } from './js/loadPredictions.js';
    import { showFormPredictPopup } from './js/components/formPredictPopup.js';
    import { renderStageTabs } from './js/components/renderStageTabs.js';
    import { renderStageContent } from './js/components/renderStageContent.js';
        import { showPlayerTab } from './js/components/showPlayerTab.js';
    loadNav('predictions');

    
    document.getElementById('foot-box').style.display = 'none';

        


        
        const form = document.getElementById('token-form');
        const tokenInput = document.getElementById('token-input');
        const errorMsg = document.getElementById('error-msg');
        const tokenContainer = document.querySelector('.token-container');
        const userIdDiv = document.getElementById('userId');

        function shake(element) {
                    function handleEditPlayerTab() {
                        const playerId = localStorage.getItem('userId');
                        const currentName = localStorage.getItem('display_name') || '';
                        showPlayerEditPopup({
                            currentName,
                            playerId,
                            onSuccess: (newName) => {
                                localStorage.setItem('display_name', newName);
                                showPlayerTab(newName, { onEdit: handleEditPlayerTab });
                            }
                        });
                    }
                    showPlayerTab(savedName, { onEdit: handleEditPlayerTab });
            setTimeout(() => {
                element.classList.remove('shake');
            }, 500);
        }

        function showError(msg) {
            errorMsg.textContent = msg;
            errorMsg.style.display = 'block';
            errorMsg.style.fontSize = '0.92em';
            errorMsg.style.fontWeight = 'bold';
            tokenInput.classList.add('error');
            shake(tokenInput);
            shake(errorMsg);
        }

        function hideError() {
            errorMsg.style.display = 'none';
            tokenInput.classList.remove('error');
        }

    async function renderStageTabsFromPhases(phases, rawResponse) {
            const tabsContainer = document.getElementById('stage-tabs');
            const contentBox = document.getElementById('stage-content-box');
            const footBox = document.getElementById('foot-box');
            tabsContainer.innerHTML = '';
            contentBox.innerHTML = '';
            footBox.style.display = 'none';
            footBox.classList.remove('foot-box-show');
            if (!phases || !phases.length) {
                tabsContainer.innerHTML = '<div style="color:#ffd700;opacity:0.7;">Nenhuma fase encontrada</div>';
                return;
            }
            // Usa o módulo de tabs e conteúdo
            renderStageTabs(phases, async (phase, idx) => {
                if (!phase) {
                    contentBox.innerHTML = '';
                    footBox.style.display = 'none';
                    footBox.classList.remove('foot-box-show');
                    return;
                }
                // Renderiza o conteúdo do stage e integra o foot-box
                await renderStageContent(phase, contentBox, phase.predictions, async () => {
                    // Callback do botão Salvar
                    const player_id = localStorage.getItem('userId');
                    const major_phase_id = phase.major_phase_id;
                    const saveBtn = footBox.querySelector('#foot-box-save-btn');
                    saveBtn.disabled = true;
                    saveBtn.textContent = 'Salvando...';
                    try {
                        const mod = await import('./js/savePredictions.js');
                        const data = await mod.savePredictions({
                            player_id,
                            major_phase_id,
                            phaseGames: phase.games,
                            phaseTeams: phase.teams,
                            contentBox
                        });
                        if (data.success) {
                            saveBtn.textContent = 'Salvo!';
                            setTimeout(() => {
                                saveBtn.textContent = 'Salvar';
                                saveBtn.disabled = false;
                                window.location.reload();
                            }, 1200);
                        } else {
                            saveBtn.textContent = 'Erro';
                            setTimeout(() => { saveBtn.textContent = 'Salvar'; saveBtn.disabled = false; }, 1800);
                            alert('Erro ao salvar: ' + (data.error || 'Erro desconhecido.'));
                        }
                    } catch (err) {
                        saveBtn.textContent = 'Erro';
                        setTimeout(() => { saveBtn.textContent = 'Salvar'; saveBtn.disabled = false; }, 1800);
                        alert('Erro ao salvar: ' + (err.message || 'Erro desconhecido.'));
                    }
                });
                // Exibe o foot-box animado
                footBox.classList.remove('foot-box-show');
                footBox.style.display = 'none';
                setTimeout(() => {
                    footBox.style.display = '';
                    void footBox.offsetWidth;
                    footBox.classList.add('foot-box-show');
                }, 10);
            });
        }

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            hideError();
            userIdDiv.classList.add('hidden');
            const token = tokenInput.value.trim().toUpperCase();
            if (!token) return;
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Carregando...';
            try {
                
                const res = await fetch(`${API_BASE_URL}/api/validateToken`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token })
                });
                const data = await res.json();
                if (data.valid) {
                    const tokenContainerEl = document.querySelector('.token-container');
                    tokenContainerEl.classList.add('hidden');
                    tokenContainerEl.style.display = 'none';
                    userIdDiv.classList.remove('hidden');
                    localStorage.setItem('userId', data.userId);
                    if (data.display_name) {
                        localStorage.setItem('display_name', data.display_name);
                    }
                                        function handleEditPlayerTab() {
                                            const playerId = localStorage.getItem('userId');
                                            const currentName = localStorage.getItem('display_name') || '';
                                            showPlayerEditPopup({
                                                currentName,
                                                playerId,
                                                onSuccess: (newName) => {
                                                    localStorage.setItem('display_name', newName);
                                                    showPlayerTab(newName, { onEdit: handleEditPlayerTab });
                                                }
                                            });
                                        }
                                        showPlayerTab(data.display_name, { onEdit: handleEditPlayerTab });
                    
                    import('./js/components/nav.js').then(mod => mod.loadNav('predictions'));
                    
                    const predictions = await loadPredictions(data.userId);
                    renderStageTabsFromPhases(predictions.phases, predictions);
                } else {
                    showError('Token inválido ..');
                }
            } catch (err) {
                showError('Erro de conexão com a API.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Continuar';
            }
        });

        
        const savedName = localStorage.getItem('display_name');
        const savedUserId = localStorage.getItem('userId');
        if (savedName && savedUserId) {
            const tokenContainerEl = document.querySelector('.token-container');
            tokenContainerEl.classList.add('hidden');
            tokenContainerEl.style.display = 'none';
            userIdDiv.classList.remove('hidden');
            showPlayerTab(savedName);
           
            loadPredictions(savedUserId).then(predictions => {
                renderStageTabsFromPhases(predictions.phases, predictions);
            });
        }
    </script>
</body>
</html>
